Terrible finite state machine thing